{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Welcome to migrate_forge Docs","text":""},{"location":"about/","title":"About this site","text":""},{"location":"about/features/extensions/","title":"Markdown Extensions","text":"<p>Note</p> <p>Admonitions are a great way to make notes to your readers. This is a note.</p> <p>Button</p> <pre><code>import tensorflow as tf # code block\n</code></pre> Block1Block2 <p>Text 1</p> <p>Text 2</p> <p>Text can be deleted and replacement text added. This can also be combined into onea single operation. Highlighting is also possible and comments can be added inline.</p> <ul> <li> Grid 1</li> <li> Grid 2</li> <li> Grid 3</li> <li> Grid 4</li> </ul> <p> </p> <p></p> <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed neque elit,</p> <ul> <li> Lorem ipsum dolor sit amet, consectetur adipiscing elit</li> <li> Vestibulum convallis sit amet nisi a tincidunt<ul> <li> In hac habitasse platea dictumst</li> <li> In scelerisque nibh non dolor mollis congue sed et metus</li> <li> Praesent sed risus massa</li> </ul> </li> <li> Aenean pretium efficitur erat, donec pharetra, ligula non scelerisque</li> </ul> <pre><code>for demo purposes - you can easily delete this file\n</code></pre>"},{"location":"about/features/plugins/","title":"Installed plugins","text":"<ul> <li>search (built-in)</li> <li>blog (built-in)</li> <li>awesome-pages</li> <li> <p>with-pdf</p> <p>for demo purposes - you can easily delete this file </p> </li> </ul>"},{"location":"examples/wizard/","title":"Laravel Forge Migration Wizard","text":""},{"location":"examples/wizard/#steps","title":"Steps","text":""},{"location":"examples/wizard/#step-1-select-the-source-server","title":"Step 1: Select the source server","text":"<ul> <li>\u2705  Source server: [old-server]</li> <li>\u23f3  Connecting to [old-server] to list sites...</li> </ul>"},{"location":"examples/wizard/#step-2-select-the-site-to-migrate","title":"Step 2: Select the site to migrate","text":"<ul> <li>\u2705  Source site:"},{"location":"examples/wizard/#step-3-what-to-include-in-the-migration","title":"Step 3: What to include in the migration?","text":"<ul> <li>Include database dump? [Y/n]</li> <li>Include storage/app? [Y/n]</li> </ul>"},{"location":"examples/wizard/#step-4-select-the-destination-server","title":"Step 4: Select the destination server","text":"<ul> <li>\u2705  Destination server: [new-server]</li> </ul>"},{"location":"examples/wizard/#step-5-destination-site","title":"Step 5: Destination site","text":"<ul> <li>\u23f3  Connecting to [new-server] to list existing sites...</li> <li>\u2705  Destination site:"},{"location":"examples/wizard/#migration-plan","title":"Migration Plan","text":"<ul> <li>Source : [old-server] -&gt; /home/forge/ <li>Dest   : [new-server] -&gt; /home/forge/ <li>Include: database=y, storage/app=y</li>"},{"location":"examples/wizard/#step-1-create-backup-on-source-server","title":"Step 1: Create backup on source server","text":"<pre><code>ssh [old-server]\n./migrate_forge.sh backup -d &lt;old-site&gt; -r /home/forge/&lt;old-site&gt;\n</code></pre>"},{"location":"examples/wizard/#step-2-transfer-archive-to-destination","title":"Step 2: Transfer archive to destination","text":"<pre><code>scp [old-server]:/home/forge/&lt;old-site&gt;/migrate_*.zip /tmp/\nscp /tmp/migrate_*.zip [new-server]:/tmp/\n</code></pre>"},{"location":"examples/wizard/#step-3-optional-setup-new-site-via-forge-api","title":"Step 3: (Optional) Setup new site via Forge API","text":"<pre><code>./migrate_forge.sh setup -d &lt;old-site&gt; -s &lt;source_server_id&gt; -D &lt;dest_server_id&gt;\n(requires FORGE_API_TOKEN in .env)\n</code></pre>"},{"location":"examples/wizard/#step-4-restore-on-destination-server","title":"Step 4: Restore on destination server","text":"<pre><code>ssh [new-server]\n./migrate_forge.sh restore /tmp/migrate_*.zip -r /home/forge/&lt;new-site&gt;\n</code></pre>"},{"location":"examples/wizard/#step-5-verify-and-update-dns","title":"Step 5: Verify and update DNS","text":"<ul> <li>Review .env on destination (especially DB credentials)</li> <li>Test the site on the new server</li> <li>Update DNS records for  to point to [new-server] <li>Wait for DNS propagation</li> <li>Request SSL certificate if not done in setup step</li> <p>\u2705  Migration plan generated. Follow the steps above in order.</p>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/","title":"2026 02 06.forge migration script","text":""},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#purpose","title":"Purpose","text":"<p>Implement a bash script (bashew-based) to migrate a Laravel website with all its data from one Laravel Forge-managed server to another. Uses a backup/restore strategy with a password-protected zip file as the transport mechanism.</p>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#core-principles","title":"Core Principles","text":"<ol> <li>Context is King: Include ALL necessary documentation, examples, and caveats</li> <li>Validation Loops: Provide executable tests/lints the AI can run and fix</li> <li>Information Dense: Use keywords and patterns from the codebase</li> <li>Progressive Success: Start simple, validate, then enhance</li> <li>Global rules: Be sure to follow all rules in CLAUDE.md</li> </ol>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#goal","title":"Goal","text":"<p>Build <code>migrate_forge.sh</code> with three main verbs: - backup: Run on source server - packs .env, database dump, and storage/app into a password-protected zip - restore: Run on destination server - prompts for password, unzips, restores .env, database, and storage/app - setup: Uses Laravel Forge API to create the site on the new server, install git repo, configure deployment script, and request SSL certificate - wizard: Interactive guided migration - picks servers from ~/.ssh/config, lists sites, asks what to include, then outputs a step-by-step migration plan with exact commands</p>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#why","title":"Why","text":"<ul> <li>Migrating Laravel sites between Forge servers is a common but error-prone manual process</li> <li>A single zip file as transport is simple, secure (password-protected), and auditable</li> <li>Separating data migration (backup/restore) from infrastructure setup (Forge API) keeps concerns clean</li> <li>Works across different server providers as long as both are Forge-managed</li> </ul>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#what","title":"What","text":""},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#user-visible-behavior","title":"User-visible behavior","text":"<p><code>migrate_forge backup</code> (run on source server via SSH): 1. Detects the Laravel project root (looks for artisan file) 2. Dumps the MySQL database using mysqldump (credentials from .env) 3. Copies the .env file (excluding server-dependent vars like DB_HOST, REDIS_HOST, etc.) 4. Copies the storage/app folder only (not logs/cache/sessions) 5. Creates a manifest file with metadata (domain, PHP version, git remote, timestamp) 6. Zips everything into a password-protected archive 7. Outputs the path to the zip file</p> <p><code>migrate_forge restore</code> (run on destination server via SSH): 1. Prompts for the password 2. Extracts the zip file 3. Smart .env merge:    - Variables only in backup: add to current .env    - Variables only in current .env: keep as-is    - Same value in both: keep as-is    - Different value: prompt user, default = keep current .env value 4. Imports the MySQL database dump 5. Restores storage/app folder (backs up existing first) 6. Runs <code>php artisan config:cache</code> and <code>php artisan migrate</code> 7. Sets correct file permissions (forge:forge, 775)</p> <p><code>migrate_forge setup</code> (run from any machine with Forge API access): 1. Creates a new site on the destination server via Forge API 2. Installs the git repository (same repo/branch as source) 3. Copies the deployment script from the source site 4. Triggers initial deployment 5. Requests Let's Encrypt SSL certificate</p>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#success-criteria","title":"Success Criteria","text":"<ul> <li> <code>backup</code> creates a valid password-protected zip with .env, db dump, storage/app, and manifest</li> <li> <code>restore</code> correctly restores all components from the zip</li> <li> <code>setup</code> creates a functional site on the destination server via Forge API</li> <li> Script follows bashew conventions (IO:debug, IO:print, IO:die, Os:require, etc.)</li> <li> Script handles MySQL databases (mysqldump for backup, mysql for restore)</li> <li> Script validates prerequisites before starting each action</li> <li> <code>bash -n migrate_forge.sh</code> passes (syntax check)</li> <li> <code>shellcheck migrate_forge.sh</code> passes with no errors (warnings acceptable)</li> </ul>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#all-needed-context","title":"All Needed Context","text":""},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#documentation-references","title":"Documentation &amp; References","text":"<pre><code>- url: https://forge.laravel.com/docs/api-reference/introduction\n  why: \"Forge API authentication: Bearer token, base URL https://forge.laravel.com/api, required headers Accept/Content-Type application/json\"\n\n- url: https://forge.laravel.com/api-documentation\n  why: |\n    Current v1 API endpoints (works until March 2026):\n    - GET /api/v1/servers - list servers\n    - GET /api/v1/servers/{id} - get server\n    - GET /api/v1/servers/{serverId}/sites - list sites\n    - GET /api/v1/servers/{serverId}/sites/{siteId} - get site\n    - POST /api/v1/servers/{serverId}/sites - create site (params: domain, project_type, aliases, directory, php_version, database)\n    - POST /api/v1/servers/{serverId}/sites/{siteId}/git - install repository (params: provider, repository, branch, composer)\n    - GET /api/v1/servers/{serverId}/sites/{siteId}/deployment/script - get deployment script\n    - PUT /api/v1/servers/{serverId}/sites/{siteId}/deployment/script - update deployment script (params: content)\n    - GET /api/v1/servers/{serverId}/sites/{siteId}/env - get .env file\n    - PUT /api/v1/servers/{serverId}/sites/{siteId}/env - update .env file (params: content)\n    - POST /api/v1/servers/{serverId}/sites/{siteId}/certificates/letsencrypt - request Let's Encrypt cert (params: domains array)\n    - GET /api/v1/servers/{serverId}/sites/{siteId}/nginx - get nginx config\n    - PUT /api/v1/servers/{serverId}/sites/{siteId}/nginx - update nginx config (params: content)\n    - POST /api/v1/servers/{serverId}/sites/{siteId}/deployment/deploy - trigger deployment\n\n- url: https://forge.laravel.com/docs/cli\n  why: |\n    Forge CLI commands (alternative to API, requires PHP):\n    - forge env:pull example.com .env - download .env\n    - forge env:push example.com .env - upload .env\n    - forge deploy example.com - trigger deployment\n    - forge ssh server-name - SSH into server\n    - forge command example.com --command=\"php artisan ...\" - run remote command\n\n- url: https://spatie.be/docs/laravel-backup/v9/taking-backups/overview\n  why: |\n    Alternative for database backup (if spatie/laravel-backup is installed):\n    - php artisan backup:run --only-db - backup only database\n    - Creates zip at: &lt;app-name&gt;/&lt;Y-m-d-H-i-s&gt;.zip\n    User suggested using this package for db backup/restore\n\n- file: migrate_forge.sh\n  why: |\n    This is the bashew-based script to modify. Key patterns:\n    - Option:config() defines flags/options/params/choices\n    - Script:main() dispatches to verb functions via case statement\n    - Helper functions like do_action1() implement the verbs\n    - IO:print/debug/die/success/alert for output\n    - Os:require \"binary\" [\"package\"] for dependency checking\n    - Os:tempfile [ext] for temp files\n    - $TMP_DIR and $LOG_DIR are auto-managed\n    - .env files are auto-loaded from script folder and cwd\n</code></pre>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#current-codebase-tree","title":"Current Codebase tree","text":"<pre><code>migrate_forge/\n\u251c\u2500\u2500 .git/\n\u251c\u2500\u2500 .claude/\n\u251c\u2500\u2500 .idea/\n\u2514\u2500\u2500 migrate_forge.sh          # main bashew script (only file)\n</code></pre>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#desired-codebase-tree","title":"Desired Codebase tree","text":"<pre><code>migrate_forge/\n\u251c\u2500\u2500 .git/\n\u251c\u2500\u2500 .claude/\n\u251c\u2500\u2500 docs/\n\u2502   \u2514\u2500\u2500 todo/\n\u2502       \u2514\u2500\u2500 PRPs/\n\u2502           \u2514\u2500\u2500 2026-02-06.forge-migration-script.md  # this PRP\n\u251c\u2500\u2500 migrate_forge.sh          # main script with all verbs implemented\n\u2514\u2500\u2500 .env.example              # example config with FORGE_API_TOKEN etc.\n</code></pre>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#known-gotchas-caveats","title":"Known Gotchas &amp; Caveats","text":"<pre><code># CRITICAL: zip password protection\n# Use `zip -e -P \"$password\"` for encryption, but password on CLI is visible in `ps`\n# Better: use `zip -e` which prompts for password interactively\n# Or: use `7z a -p\"$password\" -mhe=on` for AES-256 encryption (stronger)\n# Decision: use zip with interactive password prompt for backup, prompt for restore\n\n# CRITICAL: Database detection\n# Parse .env for DB_CONNECTION (mysql|pgsql|sqlite)\n# Parse DB_HOST, DB_PORT, DB_DATABASE, DB_USERNAME, DB_PASSWORD\n# MySQL: mysqldump --single-transaction --routines --triggers\n# PostgreSQL: pg_dump --format=custom (or plain SQL with pg_dump --format=plain)\n# Restore: mysql &lt; dump.sql / pg_restore or psql &lt; dump.sql\n\n# CRITICAL: Large storage folders\n# storage/app can be huge. Use rsync-style progress or warn user about size\n# zip compression helps but may still be large\n\n# CRITICAL: File permissions after restore\n# Laravel needs: storage/ and bootstrap/cache/ writable by web server\n# chown -R www-data:www-data storage bootstrap/cache (or forge:forge on Forge servers)\n# chmod -R 775 storage bootstrap/cache\n\n# CRITICAL: Forge API rate limiting\n# API returns 429 if too many requests. Add small delays between API calls.\n\n# CRITICAL: .env differences between servers\n# Source .env may have different DB credentials, Redis host, queue driver, etc.\n# Restore should warn user to review/update the .env after restoring\n\n# GOTCHA: The script itself needs to run ON the servers for backup/restore\n# but FROM any machine for the setup verb (which only uses the API)\n# So backup/restore need: zip/unzip, mysql/mysqldump or pg_dump/pg_restore\n# And setup needs: curl, jq (for JSON parsing)\n</code></pre>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#implementation-blueprint","title":"Implementation Blueprint","text":""},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#data-models-and-structure","title":"Data models and structure","text":"<p>The migration archive (zip file) contains: <pre><code>migrate_DOMAIN_YYYY-MM-DD.zip\n\u251c\u2500\u2500 manifest.json          # metadata about the migration\n\u251c\u2500\u2500 dotenv                 # the .env file (renamed to avoid issues)\n\u251c\u2500\u2500 database.sql           # database dump (MySQL or PostgreSQL)\n\u2514\u2500\u2500 storage/               # storage/app folder contents\n    \u2514\u2500\u2500 app/\n        \u251c\u2500\u2500 public/\n        \u2514\u2500\u2500 ...\n</code></pre></p> <p>manifest.json structure: <pre><code>{\n  \"domain\": \"example.com\",\n  \"created_at\": \"2026-02-06T12:00:00Z\",\n  \"script_version\": \"0.0.1\",\n  \"laravel_version\": \"11.x\",\n  \"php_version\": \"8.3\",\n  \"db_connection\": \"mysql\",\n  \"db_database\": \"example_db\",\n  \"git_remote\": \"git@github.com:user/repo.git\",\n  \"git_branch\": \"main\",\n  \"storage_size_mb\": 450,\n  \"source_server\": \"server-name\",\n  \"project_root\": \"/home/forge/example.com\"\n}\n</code></pre></p>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#optionsflags-to-add-to-optionconfig","title":"Options/flags to add to Option:config()","text":"<pre><code># Replace the current Option:config choices and add new options:\nflag|h|help|show usage\nflag|Q|QUIET|no output\nflag|V|VERBOSE|also show debug messages\nflag|f|FORCE|do not ask for confirmation (always yes)\noption|L|LOG_DIR|folder for log files|$HOME/log/$script_prefix\noption|T|TMP_DIR|folder for temp files|/tmp/$script_prefix\noption|d|domain|website domain name\noption|s|server|Forge server ID or name\noption|r|root|Laravel project root folder|.\noption|o|output|output zip file path\nchoice|1|action|action to perform|backup,restore,setup,check,env,update\nparam|?|input|input file/text\n</code></pre>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#list-of-tasks-to-be-completed","title":"List of tasks to be completed","text":"<pre><code>Task 1: Update Option:config() with new options and verbs\n  MODIFY migrate_forge.sh:\n  - UPDATE the Option:config() function to add: domain, server, root, output options\n  - UPDATE the choice line to: backup,restore,setup,check,env,update\n  - KEEP existing flags (help, QUIET, VERBOSE, FORCE)\n\nTask 2: Update Script:main() case statement with new verbs\n  MODIFY migrate_forge.sh:\n  - REPLACE action1/action2/action3 case blocks with backup/restore/setup\n  - ADD TIP comments for each verb\n  - KEEP check/env/update verbs as-is\n  - ADD Os:require calls at the top for common dependencies\n\nTask 3: Implement do_backup() function\n  MODIFY migrate_forge.sh:\n  - REPLACE do_action1() with do_backup()\n  - Detect Laravel project root (find artisan file)\n  - Parse .env for database credentials and app metadata\n  - Create temp working directory\n  - Dump database (MySQL: mysqldump, PostgreSQL: pg_dump)\n  - Copy .env file as \"dotenv\"\n  - Copy storage/app folder\n  - Generate manifest.json with metadata\n  - Create password-protected zip archive (prompt for password)\n  - Report the output file path and size\n  - Clean up temp directory\n\nTask 4: Implement do_restore() function\n  MODIFY migrate_forge.sh:\n  - REPLACE do_action2() with do_restore()\n  - Verify input zip file exists\n  - Prompt for zip password\n  - Extract to temp directory\n  - Read and display manifest.json\n  - Ask for confirmation to proceed\n  - Detect target Laravel project root\n  - Restore .env file (with backup of existing)\n  - Parse new .env for database credentials\n  - Import database dump (mysql or pg_restore/psql)\n  - Restore storage/app folder (with backup of existing)\n  - Fix file permissions (forge:forge ownership, 775 on storage)\n  - Run php artisan config:cache and php artisan migrate\n  - Clean up temp directory\n\nTask 5: Implement do_setup() function\n  MODIFY migrate_forge.sh:\n  - ADD do_setup() function\n  - Os:require \"curl\" and \"jq\"\n  - Read FORGE_API_TOKEN from environment or .env\n  - Verify API access with a test call (GET /api/v1/servers)\n  - Accept source server ID + site ID (or domain lookup)\n  - Accept destination server ID\n  - GET source site details (domain, PHP version, etc.)\n  - GET source deployment script\n  - GET source git repository info\n  - CREATE new site on destination server\n  - INSTALL git repository on new site\n  - UPDATE deployment script on new site\n  - DEPLOY the site\n  - REQUEST Let's Encrypt SSL certificate\n  - Report results\n\nTask 6: Implement helper functions\n  MODIFY migrate_forge.sh:\n  - ADD parse_dotenv() - parse .env file for a specific key\n  - ADD detect_project_root() - find Laravel root (artisan file)\n  - ADD forge_api() - wrapper for Forge API calls with auth header\n  - ADD dump_mysql() - mysqldump with proper flags\n  - ADD dump_pgsql() - pg_dump with proper flags\n  - ADD restore_mysql() - mysql import\n  - ADD restore_pgsql() - psql/pg_restore import\n  - ADD create_manifest() - generate manifest.json\n  - ADD read_manifest() - parse manifest.json\n\nTask 7: Create .env.example\n  CREATE .env.example with:\n  - FORGE_API_TOKEN=\n  - FORGE_SOURCE_SERVER=\n  - FORGE_SOURCE_SITE=\n  - FORGE_DEST_SERVER=\n\nTask 8: Validation and testing\n  - Run: bash -n migrate_forge.sh\n  - Run: shellcheck migrate_forge.sh\n  - Run: ./migrate_forge.sh check\n  - Run: ./migrate_forge.sh --help\n  - Fix any issues found\n</code></pre>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#per-task-pseudocode","title":"Per-task pseudocode","text":""},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#task-3-do_backup-pseudocode","title":"Task 3: do_backup() pseudocode","text":"<pre><code>function do_backup() {\n  # 1. Find Laravel root\n  local project_root\n  project_root=$(detect_project_root \"${root}\")\n  [[ ! -f \"${project_root}/artisan\" ]] &amp;&amp; IO:die \"No Laravel project found at [${project_root}]\"\n\n  # 2. Parse .env\n  local env_file=\"${project_root}/.env\"\n  [[ ! -f \"${env_file}\" ]] &amp;&amp; IO:die \"No .env file found at [${env_file}]\"\n  local db_connection db_host db_port db_database db_username db_password\n  db_connection=$(parse_dotenv \"${env_file}\" \"DB_CONNECTION\")\n  db_database=$(parse_dotenv \"${env_file}\" \"DB_DATABASE\")\n  # ... etc for all DB_ vars\n  local app_name domain_name\n  app_name=$(parse_dotenv \"${env_file}\" \"APP_NAME\")\n\n  # 3. Determine domain from option or .env APP_URL\n  [[ -z \"${domain}\" ]] &amp;&amp; domain=$(parse_dotenv \"${env_file}\" \"APP_URL\" | sed 's|https\\?://||')\n\n  # 4. Create temp working dir\n  local work_dir\n  work_dir=$(Os:tempfile \"d\")  # or use mktemp -d\n  mkdir -p \"${work_dir}\"\n\n  # 5. Dump database\n  IO:announce \"Dumping ${db_connection} database [${db_database}]...\"\n  case \"${db_connection}\" in\n    mysql)  dump_mysql \"${db_host}\" \"${db_port}\" \"${db_database}\" \"${db_username}\" \"${db_password}\" \"${work_dir}/database.sql\" ;;\n    pgsql)  dump_pgsql \"${db_host}\" \"${db_port}\" \"${db_database}\" \"${db_username}\" \"${db_password}\" \"${work_dir}/database.sql\" ;;\n    sqlite) cp \"${project_root}/database/${db_database}\" \"${work_dir}/database.sqlite\" ;;\n    *)      IO:die \"Unsupported database connection [${db_connection}]\" ;;\n  esac\n\n  # 6. Copy .env\n  cp \"${env_file}\" \"${work_dir}/dotenv\"\n\n  # 7. Copy storage/app\n  if [[ -d \"${project_root}/storage/app\" ]]; then\n    IO:announce \"Copying storage/app folder...\"\n    cp -r \"${project_root}/storage/app\" \"${work_dir}/storage_app\"\n  fi\n\n  # 8. Create manifest\n  create_manifest \"${work_dir}/manifest.json\" \"${domain}\" \"${db_connection}\" \"${db_database}\" \"${project_root}\"\n\n  # 9. Create password-protected zip\n  local zip_name\n  zip_name=\"${output:-migrate_${domain}_$(date +%Y-%m-%d).zip}\"\n  IO:announce \"Creating encrypted zip archive...\"\n  Os:require \"zip\"\n  (cd \"${work_dir}\" &amp;&amp; zip -r -e \"${zip_name}\" manifest.json dotenv database.* storage_app/ 2&gt;/dev/null)\n  # zip -e prompts for password interactively\n  mv \"${work_dir}/${zip_name}\" \"./${zip_name}\"\n\n  # 10. Report\n  local size\n  size=$(du -h \"./${zip_name}\" | cut -f1)\n  IO:success \"Backup created: ./${zip_name} (${size})\"\n\n  # 11. Cleanup\n  rm -rf \"${work_dir}\"\n}\n</code></pre>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#task-4-do_restore-pseudocode","title":"Task 4: do_restore() pseudocode","text":"<pre><code>function do_restore() {\n  local zip_file=\"${input}\"\n  [[ -z \"${zip_file}\" ]] &amp;&amp; IO:die \"Usage: $script_prefix restore &lt;zipfile&gt;\"\n  [[ ! -f \"${zip_file}\" ]] &amp;&amp; IO:die \"File not found: [${zip_file}]\"\n\n  # 1. Extract (will prompt for password)\n  Os:require \"unzip\"\n  local work_dir\n  work_dir=$(mktemp -d)\n  IO:announce \"Extracting archive (enter password when prompted)...\"\n  unzip \"${zip_file}\" -d \"${work_dir}\" || IO:die \"Failed to extract - wrong password?\"\n\n  # 2. Read manifest\n  [[ ! -f \"${work_dir}/manifest.json\" ]] &amp;&amp; IO:die \"Invalid archive - no manifest.json found\"\n  read_manifest \"${work_dir}/manifest.json\"\n  IO:print \"Migration from: ${manifest_domain} (${manifest_db_connection})\"\n  IO:print \"Created: ${manifest_created_at}\"\n\n  # 3. Confirm\n  IO:confirm \"Proceed with restore?\" || IO:die \"Aborted by user\"\n\n  # 4. Detect project root\n  local project_root\n  project_root=$(detect_project_root \"${root}\")\n\n  # 5. Restore .env (backup existing first)\n  if [[ -f \"${project_root}/.env\" ]]; then\n    cp \"${project_root}/.env\" \"${project_root}/.env.backup.$(date +%Y%m%d%H%M%S)\"\n    IO:debug \"Existing .env backed up\"\n  fi\n  cp \"${work_dir}/dotenv\" \"${project_root}/.env\"\n  IO:alert \"IMPORTANT: Review and update .env for new server (DB credentials, Redis, etc.)\"\n\n  # 6. Restore database\n  local db_connection db_host db_port db_database db_username db_password\n  # parse from the RESTORED .env (user should update DB creds first if different)\n  # OR parse from manifest and ask user\n  IO:announce \"Restoring database...\"\n  case \"${manifest_db_connection}\" in\n    mysql)  restore_mysql ... ;;\n    pgsql)  restore_pgsql ... ;;\n    sqlite) cp \"${work_dir}/database.sqlite\" \"${project_root}/database/\" ;;\n  esac\n\n  # 7. Restore storage/app\n  if [[ -d \"${work_dir}/storage_app\" ]]; then\n    IO:announce \"Restoring storage/app...\"\n    [[ -d \"${project_root}/storage/app\" ]] &amp;&amp; mv \"${project_root}/storage/app\" \"${project_root}/storage/app.backup.$(date +%Y%m%d%H%M%S)\"\n    cp -r \"${work_dir}/storage_app\" \"${project_root}/storage/app\"\n  fi\n\n  # 8. Fix permissions\n  IO:announce \"Fixing permissions...\"\n  chown -R forge:forge \"${project_root}/storage\" \"${project_root}/bootstrap/cache\" 2&gt;/dev/null || true\n  chmod -R 775 \"${project_root}/storage\" \"${project_root}/bootstrap/cache\"\n\n  # 9. Laravel cache/migrate\n  (cd \"${project_root}\" &amp;&amp; php artisan config:cache &amp;&amp; php artisan migrate --force)\n\n  # 10. Cleanup\n  rm -rf \"${work_dir}\"\n  IO:success \"Restore complete for ${manifest_domain}\"\n}\n</code></pre>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#task-5-do_setup-pseudocode","title":"Task 5: do_setup() pseudocode","text":"<pre><code>function do_setup() {\n  Os:require \"curl\"\n  Os:require \"jq\"\n\n  # 1. Get API token\n  local api_token=\"${FORGE_API_TOKEN:-}\"\n  [[ -z \"${api_token}\" ]] &amp;&amp; IO:die \"FORGE_API_TOKEN not set - add to .env or export\"\n\n  # 2. Determine source and destination\n  local source_server=\"${FORGE_SOURCE_SERVER:-${server:-}}\"\n  local dest_server=\"${FORGE_DEST_SERVER:-}\"\n  [[ -z \"${source_server}\" ]] &amp;&amp; IO:die \"Source server not specified (--server or FORGE_SOURCE_SERVER)\"\n  [[ -z \"${dest_server}\" ]] &amp;&amp; IO:die \"Destination server not specified (FORGE_DEST_SERVER)\"\n\n  # 3. Find source site by domain\n  local source_site_id\n  source_site_id=$(forge_api GET \"/api/v1/servers/${source_server}/sites\" \\\n    | jq -r \".sites[] | select(.name == \\\"${domain}\\\") | .id\")\n  [[ -z \"${source_site_id}\" ]] &amp;&amp; IO:die \"Site [${domain}] not found on server [${source_server}]\"\n\n  # 4. Get source site details\n  local site_info deploy_script\n  site_info=$(forge_api GET \"/api/v1/servers/${source_server}/sites/${source_site_id}\")\n  deploy_script=$(forge_api GET \"/api/v1/servers/${source_server}/sites/${source_site_id}/deployment/script\")\n\n  local repository branch php_version project_type directory\n  repository=$(echo \"${site_info}\" | jq -r '.site.repository')\n  branch=$(echo \"${site_info}\" | jq -r '.site.repository_branch')\n  # ... etc\n\n  # 5. Create site on destination\n  IO:announce \"Creating site [${domain}] on server [${dest_server}]...\"\n  local new_site\n  new_site=$(forge_api POST \"/api/v1/servers/${dest_server}/sites\" \\\n    \"{\\\"domain\\\":\\\"${domain}\\\",\\\"project_type\\\":\\\"php\\\",\\\"php_version\\\":\\\"${php_version}\\\",\\\"directory\\\":\\\"/public\\\"}\")\n  local new_site_id\n  new_site_id=$(echo \"${new_site}\" | jq -r '.site.id')\n\n  # 6. Install git repository\n  IO:announce \"Installing repository [${repository}] branch [${branch}]...\"\n  forge_api POST \"/api/v1/servers/${dest_server}/sites/${new_site_id}/git\" \\\n    \"{\\\"provider\\\":\\\"github\\\",\\\"repository\\\":\\\"${repository}\\\",\\\"branch\\\":\\\"${branch}\\\",\\\"composer\\\":true}\"\n\n  # 7. Update deployment script\n  IO:announce \"Updating deployment script...\"\n  forge_api PUT \"/api/v1/servers/${dest_server}/sites/${new_site_id}/deployment/script\" \\\n    \"{\\\"content\\\":$(echo \"${deploy_script}\" | jq -Rs)}\"\n\n  # 8. Deploy\n  IO:announce \"Triggering deployment...\"\n  forge_api POST \"/api/v1/servers/${dest_server}/sites/${new_site_id}/deployment/deploy\" \"\"\n\n  # 9. Request SSL\n  IO:announce \"Requesting Let's Encrypt SSL certificate...\"\n  forge_api POST \"/api/v1/servers/${dest_server}/sites/${new_site_id}/certificates/letsencrypt\" \\\n    \"{\\\"domains\\\":[\\\"${domain}\\\"]}\"\n\n  IO:success \"Site setup complete on server [${dest_server}]\"\n  IO:print \"Next steps:\"\n  IO:print \"  1. SSH into new server and run: $script_prefix restore &lt;zipfile&gt;\"\n  IO:print \"  2. Update .env on new server with correct credentials\"\n  IO:print \"  3. Update DNS to point ${domain} to new server IP\"\n}\n</code></pre>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#integration-points","title":"Integration Points","text":"<pre><code>ENVIRONMENT VARIABLES (in .env or exported):\n  - FORGE_API_TOKEN: Laravel Forge API bearer token (required for setup)\n  - FORGE_SOURCE_SERVER: Source server ID in Forge (for setup)\n  - FORGE_SOURCE_SITE: Source site ID in Forge (optional, can lookup by domain)\n  - FORGE_DEST_SERVER: Destination server ID in Forge (for setup)\n\nDEPENDENCIES:\n  backup:\n    - zip (for creating password-protected archive)\n    - mysqldump or pg_dump (for database dump)\n    - jq (for creating manifest.json)\n\n  restore:\n    - unzip (for extracting archive)\n    - mysql or psql (for database import)\n    - jq (for reading manifest.json)\n    - php (for artisan commands)\n\n  setup:\n    - curl (for Forge API calls)\n    - jq (for JSON parsing)\n</code></pre>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#validation-loop","title":"Validation Loop","text":""},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#level-1-syntax-style","title":"Level 1: Syntax &amp; Style","text":"<pre><code># Run these FIRST - fix any errors before proceeding\nbash -n migrate_forge.sh          # Syntax check - must pass with zero errors\nshellcheck migrate_forge.sh       # Static analysis - fix errors, warnings acceptable\n\n# Expected: No errors. If errors, READ the error and fix.\n</code></pre>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#level-2-smoke-tests","title":"Level 2: Smoke Tests","text":"<pre><code># These should all work without any server access:\n./migrate_forge.sh --help              # Should show usage with all verbs\n./migrate_forge.sh check               # Should show all options/flags with defaults\n./migrate_forge.sh env &gt; .env.example  # Should generate valid .env template\n\n# Test that each verb is reachable (will fail with missing deps, but shouldn't crash):\n./migrate_forge.sh backup --help 2&gt;&amp;1 | head -5   # Should not show \"action not recognized\"\n</code></pre>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#level-3-functional-tests-require-a-laravel-project","title":"Level 3: Functional Tests (require a Laravel project)","text":"<pre><code># On a server with a Laravel project:\ncd /home/forge/example.com\n/path/to/migrate_forge.sh backup -d example.com\n\n# On the destination server:\n/path/to/migrate_forge.sh restore migrate_example.com_2026-02-06.zip\n\n# From any machine with API access:\nFORGE_API_TOKEN=xxx /path/to/migrate_forge.sh setup -d example.com -s 12345\n</code></pre>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#final-validation-checklist","title":"Final Validation Checklist","text":"<ul> <li> <code>bash -n migrate_forge.sh</code> passes</li> <li> <code>shellcheck migrate_forge.sh</code> has no errors (warnings OK)</li> <li> <code>./migrate_forge.sh --help</code> shows all verbs and options correctly</li> <li> <code>./migrate_forge.sh check</code> runs without errors</li> <li> All three verbs (backup, restore, setup) are dispatched correctly in case statement</li> <li> Helper functions parse_dotenv, detect_project_root, forge_api are implemented</li> <li> Database support for both MySQL and PostgreSQL</li> <li> Password prompt works for both zip creation and extraction</li> <li> manifest.json is created/read correctly with jq</li> <li> .env.example created with all needed variables documented</li> <li> No hardcoded paths or credentials in the script</li> </ul>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#anti-patterns-to-avoid","title":"Anti-Patterns to Avoid","text":"<ul> <li>Do NOT put passwords on the command line (visible in <code>ps</code>) - use interactive prompts or read from stdin</li> <li>Do NOT use <code>eval</code> for parsing .env - use grep/awk to extract individual values safely</li> <li>Do NOT assume MySQL - always check DB_CONNECTION from .env</li> <li>Do NOT overwrite existing files without backup - always create .backup.timestamp copies</li> <li>Do NOT skip error checking on API calls - check HTTP status codes</li> <li>Do NOT store FORGE_API_TOKEN in the script - always read from environment/.env</li> <li>Do NOT modify the bashew boilerplate below the \"DO NOT MODIFY\" line</li> <li>Do NOT create separate files - everything goes in migrate_forge.sh (bashew convention)</li> </ul>"},{"location":"todo/PRPs/2026-02-06.forge-migration-script/#confidence-score-810","title":"Confidence Score: 8/10","text":"<p>High confidence because: - Clear separation of concerns (backup/restore/setup) - Well-defined data format (zip with manifest) - Standard tools (zip, mysqldump, curl, jq) - Bashew framework handles all the boilerplate</p> <p>Risks: - Large storage/app folders may take a long time to zip/transfer - Database dump format compatibility between MySQL versions - Forge API v1 deprecation (March 2026) - may need migration to new API - Edge cases: SQLite databases, custom storage disks, multi-database setups</p>"}]}